name: test-all2
on:
  push:
    branches-ignore:
      - 'dependabot/**' #avoid duplicates: only run the PR, not the commit
      - 'gh-pages' #github pages do not trigger all tests
    tags-ignore:
      - 'v*' #avoid rerun existing commit on release
  pull_request:
    branches:
      - 'main'
env:
  TEST_POSTGRES_PWD: ${RANDOM}${RANDOM}${RANDOM}

jobs:
  test-postgres:
    runs-on: ubuntu-latest
    #if: ${{ false }}  # disable for now
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'
          cache: 'maven'

      - name: Launch Postgres
        run: |
          docker run -d -p 5432:5432 --name test-postgres  --restart unless-stopped \
            -e POSTGRES_PASSWORD="$TEST_POSTGRES_PWD" \
            -e TEST_POSTGRES_PWD="$TEST_POSTGRES_PWD" \
            -v ${GITHUB_WORKSPACE}/setup/postgres:/docker-entrypoint-initdb.d \
            postgres:14

      - name: Test Postgres
        run: mvn test -Dtest=**/TestPostgres* --no-transfer-progress
